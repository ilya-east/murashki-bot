<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ê–¥–º–∏–Ω–∫–∞ Murashki</title>
  <style>
    body {
      background: #2d263a;
      color: white;
      font-family: sans-serif;
      padding: 20px;
    }

    .track {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
      padding: 12px 16px;
      background: #3b3644;
      border-radius: 16px;
    }

    .track img {
      width: 56px;
      height: 56px;
      object-fit: cover;
      border-radius: 10px;
    }

    input[type="text"] {
      flex-grow: 1;
      padding: 6px 10px;
      border: none;
      border-radius: 8px;
      background: #444;
      color: white;
    }

    button {
      background: #ff0000;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2>üéµ –ê–¥–º–∏–Ω–∫–∞ –ø–ª–µ–µ—Ä–∞</h2>

  <button onclick="updateTracks()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ç—Ä–µ–∫–∏</button>
  <button onclick="saveTracks()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å tracks.json</button>

  <div id="track-list"></div>

  <script>
    let tracks = [];

    // === –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ tracks.json ===
    function fetchAndUpdate() {
      fetch("/tracks.json")
        .then(res => res.json())
        .then(data => {
          tracks = data;
          renderTracks();
        });
    }

    // === –ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å —Ç—Ä–µ–∫–∏" ===
    function updateTracks() {
      fetch("/update")
        .then(res => {
          if (res.ok) {
            alert("‚úÖ –ù–æ–≤—ã–µ —Ç—Ä–µ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã");
            fetchAndUpdate(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º JSON
          } else {
            alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç—Ä–µ–∫–∏");
          }
        })
        .catch(err => {
          console.error("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É:", err);
          alert("–ó–∞–ø—É—Å—Ç–∏—Ç–µ server.py —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å");
        });
    }

    // === –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å tracks.json" ===
    function saveTracks() {
      const updatedTracks = tracks.map(track => ({
        title: track.title,
        author: track.author,
        audio: track.audio,
        cover: track.cover
      }));

      fetch("/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updatedTracks)
      })
      .then(res => {
        if (res.ok) {
          alert("‚úÖ tracks.json —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!");
        } else {
          alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å tracks.json");
        }
      })
      .catch(err => {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", err);
        alert("‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞");
      });
    }

    // === –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç—Ä–µ–∫–æ–≤ ===
    function renderTracks() {
      const container = document.getElementById("track-list");
      container.innerHTML = "";

      tracks.forEach((track, index) => {
        const div = document.createElement("div");
        div.className = "track";
        div.innerHTML = `
          <img src="${track.cover}" alt="cover">
          <input type="text" value="${track.title}" oninput="updateTitle(${index}, this.value)">
          <input type="text" value="${track.author}" oninput="updateAuthor(${index}, this.value)">
        `;
        container.appendChild(div);
      });
    }

    function updateTitle(index, value) {
      tracks[index].title = value;
    }

    function updateAuthor(index, value) {
      tracks[index].author = value;
    }

    // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
    window.onload = () => {
      fetchAndUpdate();
    };
  </script>
</body>
</html>